<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .client-item.selected {
            background-color: #dbeafe; /* Blue-100 */
            border-color: #93c5fd; /* Blue-300 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div class="container mx-auto p-4 flex-grow">
        <header class="flex justify-between items-center bg-white p-4 rounded-lg shadow-md mb-4">
            <h1 class="text-2xl font-semibold text-gray-800">Sistema de Gestión de Pedidos</h1>
            <div class="flex items-center space-x-4">
                <span class="text-gray-600">Panel de Admin</span>
                <button id="exportPdfBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center space-x-2 transition duration-300 ease-in-out">
                    <i class="fas fa-file-pdf"></i>
                    <span>PDF</span>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <aside class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md flex flex-col">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">Clientes</h2>

                <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <h3 class="text-lg font-medium text-blue-800 mb-3">Añadir Nuevo Cliente</h3>
                    <div class="mb-3">
                        <label for="clientName" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Cliente</label>
                        <input type="text" id="clientName" placeholder="Nombre completo" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="clientContact" class="block text-sm font-medium text-gray-700 mb-1">Contacto</label>
                        <input type="text" id="clientContact" placeholder="Teléfono o email" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button id="addClientBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Agregar Cliente
                    </button>
                </div>

                <div class="flex-grow flex flex-col">
                    <h3 class="text-lg font-medium text-gray-800 mb-3 pb-2 border-b border-gray-200">Clientes Actuales</h3>
                    <div class="mb-4">
                        <input type="text" id="searchClient" placeholder="Buscar cliente..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="clientsList" class="flex-grow overflow-y-auto pr-2 custom-scrollbar">
                        </div>
                    <button id="deleteAllClientsBtn" class="mt-4 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Eliminar todos los clientes
                    </button>
                </div>
            </aside>

            <main class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md flex flex-col">
                <div class="mb-6 pb-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Añadir Productos</h2>
                    <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200 text-blue-800 font-medium">
                        Cliente Seleccionado: <span id="selectedClientDisplay" class="font-bold">Ninguno</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-4">
                        <div>
                            <label for="productSelect" class="block text-sm font-medium text-gray-700 mb-1">Producto</label>
                            <select id="productSelect" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                </select>
                        </div>
                        <div>
                            <label for="productQuantity" class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
                            <input type="number" id="productQuantity" value="1" min="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button id="addProductToOrderBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                            + Agregar
                        </button>
                    </div>

                    <div class="overflow-x-auto rounded-lg border border-gray-200 mb-4">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th scope="col" class="relative px-6 py-3"><span class="sr-only">Acciones</span></th>
                                </tr>
                            </thead>
                            <tbody id="currentOrderTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                    <button id="registerOrderBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Registrar Pedido
                    </button>
                </div>

                <div class="flex-grow flex flex-col mb-6">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-800">Resumen de Pedidos (Cliente Seleccionado)</h2>
                        <button id="exportSummaryPdfBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center space-x-2 transition duration-300 ease-in-out">
                            <i class="fas fa-file-export"></i>
                            <span>Exportar PDF</span>
                        </button>
                    </div>

                    <div class="overflow-x-auto flex-grow rounded-lg border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unit.</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad Total</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clientes</th>
                                </tr>
                            </thead>
                            <tbody id="orderSummaryTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>

                    <div class="flex justify-end items-center mt-4 p-4 bg-gray-50 rounded-lg shadow-inner">
                        <span class="text-lg font-semibold text-gray-800 mr-4">Total General (Cliente):</span>
                        <span id="grandTotal" class="text-2xl font-bold text-blue-700">$ 0.00 USD</span>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md border-t border-gray-200 mt-auto">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">Resumen de Pedidos del Día (Todos los Clientes)</h2>
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad Total</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Dinero</th>
                                </tr>
                            </thead>
                            <tbody id="dailyOrderSummaryTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end items-center mt-4 p-4 bg-gray-50 rounded-lg shadow-inner">
                        <span class="text-lg font-semibold text-gray-800 mr-4">Total General del Día:</span>
                        <span id="dailyGrandTotalMoney" class="text-2xl font-bold text-indigo-700">$ 0.00 USD</span>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div class="fixed bottom-4 left-4 bg-gray-800 text-white text-xs px-3 py-1 rounded-full shadow-lg">
        ID de Usuario: <span id="userIdDisplay">Cargando...</span>
    </div>

    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
            <h3 id="modalTitle" class="text-lg font-semibold text-gray-800 mb-4"></h3>
            <p id="modalMessage" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out hidden">Cancelar</button>
                <button id="modalConfirmBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">Aceptar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase config and app ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        let app;
        let db;
        let auth;
        let userId = null; // Will be set after authentication
        let isAuthReady = false; // Flag to ensure auth is ready before Firestore ops

        // Product data (static for now, could be fetched from Firestore)
        const products = [
            { id: 'prod-001', name: 'MERMELADA DE GUAYABA', price: 18.00 },
            { id: 'prod-002', name: 'PULPA DE GUAYABA 1K', price: 24.00 },
            { id: 'prod-003', name: 'HOJA DE GUAYABA', price: 15.00 },
            { id: 'prod-004', name: 'MERMELADA DE FRUTILLA S/A', price: 22.00 },
            { id: 'prod-005', name: 'GUAYABADA 500G', price: 15.00 },
            { id: 'prod-006', name: 'MERMELADA DE GUAYABA S/A', price: 22.00 },
            { id: 'prod-007', name: 'MERMELADA DE FRUTILLA', price: 18.00 }
        ];

        // Current order items (volatile, not persisted directly)
        let currentOrderItems = [];
        let selectedClientForOrder = null; // Stores the currently selected client for the order

        // --- DOM Elements ---
        const clientNameInput = document.getElementById('clientName');
        const clientContactInput = document.getElementById('clientContact');
        const addClientBtn = document.getElementById('addClientBtn');
        const searchClientInput = document.getElementById('searchClient');
        const clientsListDiv = document.getElementById('clientsList');
        const deleteAllClientsBtn = document.getElementById('deleteAllClientsBtn');

        const selectedClientDisplay = document.getElementById('selectedClientDisplay'); // Display for selected client
        const productSelect = document.getElementById('productSelect');
        const productQuantityInput = document.getElementById('productQuantity');
        const addProductToOrderBtn = document.getElementById('addProductToOrderBtn');
        const currentOrderTableBody = document.getElementById('currentOrderTableBody');
        const registerOrderBtn = document.getElementById('registerOrderBtn');

        const orderSummaryTableBody = document.getElementById('orderSummaryTableBody');
        const grandTotalSpan = document.getElementById('grandTotal');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const exportSummaryPdfBtn = document.getElementById('exportSummaryPdfBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // Daily Totals Display Elements
        const dailyOrderSummaryTableBody = document.getElementById('dailyOrderSummaryTableBody');
        const dailyGrandTotalMoneySpan = document.getElementById('dailyGrandTotalMoney');

        // Custom Modal elements (still exist in HTML but not used by default)
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        // --- Utility Functions (modified to remove notifications) ---

        /**
         * Displays a custom modal message. (No longer used for success/error notifications by default)
         * Kept for potential future use or debugging.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message content.
         * @param {boolean} isConfirm - If true, shows a cancel button for confirmation.
         * @returns {Promise<boolean>} - Resolves to true if confirmed, false if cancelled.
         */
        function showCustomModal(title, message, isConfirm = false) {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                customModal.classList.remove('hidden');

                if (isConfirm) {
                    modalCancelBtn.classList.remove('hidden');
                    modalConfirmBtn.textContent = 'Confirmar';
                } else {
                    modalCancelBtn.classList.add('hidden');
                    modalConfirmBtn.textContent = 'Aceptar';
                }

                const confirmHandler = () => {
                    customModal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', confirmHandler);
                    modalCancelBtn.removeEventListener('click', cancelHandler);
                    resolve(true);
                };

                const cancelHandler = () => {
                    customModal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', confirmHandler);
                    modalCancelBtn.removeEventListener('click', cancelHandler);
                    resolve(false);
                };

                modalConfirmBtn.addEventListener('click', confirmHandler);
                modalCancelBtn.addEventListener('click', cancelHandler);
            });
        }

        /**
         * Formats a number as currency.
         * @param {number} amount - The number to format.
         * @returns {string} - Formatted currency string.
         */
        function formatCurrency(amount) {
            return `$ ${amount.toFixed(2)}`;
        }

        // --- Firebase Initialization and Authentication ---
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        isAuthReady = true;
                        console.log("Firebase initialized and user authenticated:", userId);
                        // Start listening to Firestore data once authenticated
                        setupFirestoreListeners();
                    } else {
                        // Sign in anonymously if no user is authenticated and no custom token
                        if (!initialAuthToken) {
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously.");
                        } else {
                            // Use custom token if provided
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log("Signed in with custom token.");
                            } catch (error) {
                                console.error("Error signing in with custom token:", error);
                                await signInAnonymously(auth); // Fallback to anonymous
                                console.log("Fallback to anonymous sign-in.");
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                // showCustomModal("Error de Inicialización", "No se pudo inicializar Firebase. Por favor, recarga la página."); // Removed notification
            }
        }

        // --- Firestore Data Management ---

        /**
         * Sets up real-time listeners for clients and orders.
         */
        function setupFirestoreListeners() {
            if (!isAuthReady || !userId) {
                console.warn("Firestore listeners not set up: Auth not ready or userId is null.");
                return;
            }

            // Listen for clients
            const clientsColRef = collection(db, `artifacts/${appId}/users/${userId}/clients`);
            onSnapshot(clientsColRef, (snapshot) => {
                const clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderClients(clients);
            }, (error) => {
                console.error("Error fetching clients:", error);
                // showCustomModal("Error de Datos", "No se pudieron cargar los clientes."); // Removed notification
            });

            // Listen for orders
            const ordersColRef = collection(db, `artifacts/${appId}/users/${userId}/orders`);
            onSnapshot(ordersColRef, (snapshot) => {
                const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Render summary for selected client
                renderOrderSummary(orders, selectedClientForOrder ? selectedClientForOrder.id : null);
                // Render daily totals for all orders
                renderDailyTotals(orders);
            }, (error) => {
                console.error("Error fetching orders:", error);
                // showCustomModal("Error de Datos", "No se pudieron cargar los pedidos."); // Removed notification
            });
        }

        /**
         * Adds a new client to Firestore.
         */
        async function addClient() {
            if (!isAuthReady || !userId) {
                console.warn("Attempted to add client before authentication is ready.");
                return;
            }
            const name = clientNameInput.value.trim();
            const contact = clientContactInput.value.trim();

            if (name === '') {
                console.warn("Client name cannot be empty.");
                return;
            }

            try {
                const clientsColRef = collection(db, `artifacts/${appId}/users/${userId}/clients`);
                await addDoc(clientsColRef, {
                    name: name,
                    contact: contact,
                    createdAt: new Date()
                });
                clientNameInput.value = '';
                clientContactInput.value = '';
                // showCustomModal("Éxito", "Cliente añadido correctamente."); // Removed notification
            } catch (e) {
                console.error("Error adding document: ", e);
                // showCustomModal("Error", "No se pudo añadir el cliente."); // Removed notification
            }
        }

        /**
         * Deletes a client from Firestore.
         * @param {string} clientId - The ID of the client to delete.
         */
        async function deleteClient(clientId) {
            if (!isAuthReady || !userId) {
                console.warn("Attempted to delete client before authentication is ready.");
                return;
            }
            // Removed confirmation modal: const confirmed = await showCustomModal("Confirmar Eliminación", "¿Estás seguro de que quieres eliminar este cliente?", true);
            // if (!confirmed) return; // Removed confirmation check

            try {
                const clientDocRef = doc(db, `artifacts/${appId}/users/${userId}/clients`, clientId);
                await deleteDoc(clientDocRef);
                // showCustomModal("Éxito", "Cliente eliminado correctamente."); // Removed notification
                // If the deleted client was the selected one, clear selection
                if (selectedClientForOrder && selectedClientForOrder.id === clientId) {
                    selectClientForOrder(null, null);
                }
            } catch (e) {
                console.error("Error removing document: ", e);
                // showCustomModal("Error", "No se pudo eliminar el cliente."); // Removed notification
            }
        }

        /**
         * Deletes all clients from Firestore.
         */
        async function deleteAllClients() {
            if (!isAuthReady || !userId) {
                console.warn("Attempted to delete all clients before authentication is ready.");
                return;
            }
            // Removed confirmation modal: const confirmed = await showCustomModal("Confirmar Eliminación", "¿Estás seguro de que quieres eliminar TODOS los clientes?", true);
            // if (!confirmed) return; // Removed confirmation check

            try {
                const clientsColRef = collection(db, `artifacts/${appId}/users/${userId}/clients`);
                const q = query(clientsColRef);
                const querySnapshot = await getDocs(q);
                // Use a batch write for efficiency when deleting multiple documents
                const batch = db.batch();

                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                // showCustomModal("Éxito", "Todos los clientes eliminados correctamente."); // Removed notification
                selectClientForOrder(null, null); // Clear any selected client
            } catch (e) {
                console.error("Error deleting all clients: ", e);
                // showCustomModal("Error", "No se pudieron eliminar todos los clientes."); // Removed notification
            }
        }

        /**
         * Adds an order to Firestore.
         * @param {object} orderData - Object containing order details (items, total, client).
         */
        async function addOrder(orderData) {
            if (!isAuthReady || !userId) {
                console.warn("Attempted to add order before authentication is ready.");
                return;
            }
            try {
                const ordersColRef = collection(db, `artifacts/${appId}/users/${userId}/orders`);
                await addDoc(ordersColRef, {
                    items: JSON.stringify(orderData.items), // Store array as JSON string
                    total: orderData.total,
                    clientId: orderData.clientId, // Store client ID
                    clientName: orderData.clientName, // Store client name for display
                    createdAt: new Date()
                });
                // showCustomModal("Éxito", "Pedido registrado correctamente."); // Removed notification
            } catch (e) {
                console.error("Error adding order: ", e);
                // showCustomModal("Error", "No se pudo registrar el pedido."); // Removed notification
            }
        }

        // --- Client Selection Logic ---

        /**
         * Selects a client for the current order and updates the UI.
         * @param {string|null} clientId - The ID of the client to select, or null to deselect.
         * @param {string|null} clientName - The name of the client to select, or null.
         */
        function selectClientForOrder(clientId, clientName) {
            if (clientId && clientName) {
                selectedClientForOrder = { id: clientId, name: clientName };
                selectedClientDisplay.textContent = clientName;
            } else {
                selectedClientForOrder = null;
                selectedClientDisplay.textContent = "Ninguno";
            }

            // Re-render clients to update highlighting
            const clientsColRef = collection(db, `artifacts/${appId}/users/${userId}/clients`);
            getDocs(clientsColRef).then(snapshot => {
                const clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderClients(clients);
            }).catch(error => {
                console.error("Error re-rendering clients after selection:", error);
            });

            // Re-render order summary, filtered by selected client or all
            const ordersColRef = collection(db, `artifacts/${appId}/users/${userId}/orders`);
            onSnapshot(ordersColRef, (snapshot) => {
                const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOrderSummary(orders, selectedClientForOrder ? selectedClientForOrder.id : null);
                renderDailyTotals(orders); // Update daily totals as well
            }, (error) => {
                console.error("Error fetching orders for summary after client selection:", error);
            });
        }


        // --- Rendering Functions ---

        /**
         * Renders the list of clients in the UI.
         * @param {Array} clients - Array of client objects.
         */
        function renderClients(clients) {
            clientsListDiv.innerHTML = '';
            const searchTerm = searchClientInput.value.toLowerCase();
            const filteredClients = clients.filter(client =>
                client.name.toLowerCase().includes(searchTerm) ||
                client.contact.toLowerCase().includes(searchTerm)
            );

            if (filteredClients.length === 0) {
                clientsListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No hay clientes para mostrar.</p>';
                return;
            }

            filteredClients.forEach(client => {
                const clientDiv = document.createElement('div');
                clientDiv.className = `flex justify-between items-center bg-gray-100 p-3 rounded-lg mb-2 shadow-sm border border-gray-200 cursor-pointer hover:bg-gray-200 transition duration-150 ease-in-out client-item ${selectedClientForOrder && selectedClientForOrder.id === client.id ? 'selected' : ''}`;
                clientDiv.dataset.clientId = client.id;
                clientDiv.dataset.clientName = client.name; // Store client name for easy access

                clientDiv.innerHTML = `
                    <span class="font-medium text-gray-700">${client.name}</span>
                    <button data-client-id="${client.id}" class="delete-client-btn text-red-500 hover:text-red-700 transition duration-300 ease-in-out ml-2">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                clientsListDiv.appendChild(clientDiv);
            });

            // Attach event listeners to delete buttons
            clientsListDiv.querySelectorAll('.delete-client-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent client selection when deleting
                    const clientId = event.currentTarget.dataset.clientId;
                    deleteClient(clientId);
                });
            });

            // Attach event listeners to client items for selection
            clientsListDiv.querySelectorAll('.client-item').forEach(item => {
                item.addEventListener('click', (event) => {
                    const clientId = event.currentTarget.dataset.clientId;
                    const clientName = event.currentTarget.dataset.clientName;
                    selectClientForOrder(clientId, clientName);
                });
            });
        }

        /**
         * Populates the product select dropdown.
         */
        function populateProductSelect() {
            productSelect.innerHTML = '';
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} (${formatCurrency(product.price)})`;
                option.dataset.price = product.price; // Store price in dataset
                productSelect.appendChild(option);
            });
        }

        /**
         * Adds a selected product to the current order table.
         */
        function addProductToCurrentOrder() {
            const selectedProductId = productSelect.value;
            const selectedProduct = products.find(p => p.id === selectedProductId);
            const quantity = parseInt(productQuantityInput.value);

            if (!selectedProduct || isNaN(quantity) || quantity <= 0) {
                console.warn("Invalid product or quantity selected.");
                return;
            }

            const existingItemIndex = currentOrderItems.findIndex(item => item.id === selectedProductId);

            if (existingItemIndex > -1) {
                // If product already in order, update quantity
                currentOrderItems[existingItemIndex].quantity += quantity;
                currentOrderItems[existingItemIndex].total = currentOrderItems[existingItemIndex].quantity * currentOrderItems[existingItemIndex].price;
            } else {
                // Add new product to order
                currentOrderItems.push({
                    id: selectedProduct.id,
                    name: selectedProduct.name,
                    price: selectedProduct.price,
                    quantity: quantity,
                    total: selectedProduct.price * quantity
                });
            }

            renderCurrentOrder();
            productQuantityInput.value = 1; // Reset quantity
        }

        /**
         * Renders the current order items in the table.
         */
        function renderCurrentOrder() {
            currentOrderTableBody.innerHTML = '';
            if (currentOrderItems.length === 0) {
                currentOrderTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">No hay productos en el pedido actual.</td>
                    </tr>
                `;
                return;
            }

            currentOrderItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(item.price)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(item.total)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-index="${index}" class="remove-item-btn text-red-500 hover:text-red-700 transition duration-300 ease-in-out">
                            <i class="fas fa-times-circle"></i>
                        </button>
                    </td>
                `;
                currentOrderTableBody.appendChild(row);
            });

            // Attach event listeners to remove buttons
            currentOrderTableBody.querySelectorAll('.remove-item-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const indexToRemove = parseInt(event.currentTarget.dataset.index);
                    currentOrderItems.splice(indexToRemove, 1);
                    renderCurrentOrder();
                });
            });
        }

        /**
         * Registers the current order with the selected client.
         */
        async function registerOrder() {
            if (!selectedClientForOrder) {
                console.warn("No client selected for the order.");
                return;
            }

            if (currentOrderItems.length === 0) {
                console.warn("Current order is empty.");
                return;
            }

            const totalOrderAmount = currentOrderItems.reduce((sum, item) => sum + item.total, 0);

            // Removed confirmation modal and its logic
            await addOrder({
                items: currentOrderItems,
                total: totalOrderAmount,
                clientId: selectedClientForOrder.id,
                clientName: selectedClientForOrder.name
            });
            currentOrderItems = []; // Clear current order after saving
            renderCurrentOrder();
            // Keep the client selected, but clear the current order items
        }

        /**
         * Renders the order summary table and calculates the grand total for the selected client.
         * @param {Array} orders - Array of order objects from Firestore.
         * @param {string|null} filterClientId - Optional client ID to filter the summary by.
         */
        function renderOrderSummary(orders, filterClientId = null) {
            orderSummaryTableBody.innerHTML = '';
            let grandTotalForClient = 0;

            // Filter orders if a client ID is provided
            const filteredOrders = filterClientId ? orders.filter(order => order.clientId === filterClientId) : orders;

            // Aggregate data for summary
            const productSummary = {}; // { productName: { priceUnit, totalQuantity, totalAmount, clients: [] } }

            filteredOrders.forEach(order => {
                // Ensure items are parsed from JSON string
                const items = JSON.parse(order.items || '[]');
                const clientName = order.clientName || 'Desconocido'; // Use clientName from order

                items.forEach(item => {
                    if (!productSummary[item.name]) {
                        productSummary[item.name] = {
                            priceUnit: item.price,
                            totalQuantity: 0,
                            totalAmount: 0,
                            clients: new Set() // Use Set to avoid duplicate client names
                        };
                    }
                    productSummary[item.name].totalQuantity += item.quantity;
                    productSummary[item.name].totalAmount += item.total;
                    productSummary[item.name].clients.add(clientName);
                });
            });

            // Sort products by name for consistent display
            const sortedProductNames = Object.keys(productSummary).sort();

            if (sortedProductNames.length === 0) {
                orderSummaryTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">No hay pedidos registrados para este cliente.</td>
                    </tr>
                `;
            } else {
                sortedProductNames.forEach(productName => {
                    const summary = productSummary[productName];
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${productName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(summary.priceUnit)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${summary.totalQuantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(summary.totalAmount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${Array.from(summary.clients).join(', ')}</td>
                    `;
                    orderSummaryTableBody.appendChild(row);
                    grandTotalForClient += summary.totalAmount;
                });
            }

            grandTotalSpan.textContent = formatCurrency(grandTotalForClient);
        }

        /**
         * Renders the overall daily totals (products and money) from all orders.
         * Now shows a detailed table of product totals.
         * @param {Array} allOrders - All order objects from Firestore (unfiltered).
         */
        function renderDailyTotals(allOrders) {
            dailyOrderSummaryTableBody.innerHTML = '';
            let totalMoneyToday = 0;

            // Aggregate data for daily summary by product
            const dailyProductSummary = {}; // { productName: { totalQuantity, totalAmount } }

            allOrders.forEach(order => {
                const items = JSON.parse(order.items || '[]');
                items.forEach(item => {
                    if (!dailyProductSummary[item.name]) {
                        dailyProductSummary[item.name] = {
                            totalQuantity: 0,
                            totalAmount: 0
                        };
                    }
                    dailyProductSummary[item.name].totalQuantity += item.quantity;
                    dailyProductSummary[item.name].totalAmount += item.total;
                    totalMoneyToday += item.total; // Sum up for overall daily money total
                });
            });

            // Sort products by name for consistent display
            const sortedProductNames = Object.keys(dailyProductSummary).sort();

            if (sortedProductNames.length === 0) {
                dailyOrderSummaryTableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="px-6 py-4 text-center text-gray-500">No hay pedidos registrados para el día.</td>
                    </tr>
                `;
            } else {
                sortedProductNames.forEach(productName => {
                    const summary = dailyProductSummary[productName];
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${productName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${summary.totalQuantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(summary.totalAmount)}</td>
                    `;
                    dailyOrderSummaryTableBody.appendChild(row);
                });
            }

            dailyGrandTotalMoneySpan.textContent = formatCurrency(totalMoneyToday);
        }


        // --- Event Listeners ---

        window.onload = function() {
            initializeFirebase();
            populateProductSelect();
            renderCurrentOrder(); // Initialize empty current order table
            selectedClientDisplay.textContent = "Ninguno"; // Initial state
        };

        addClientBtn.addEventListener('click', addClient);
        searchClientInput.addEventListener('input', async (event) => {
            if (!isAuthReady || !userId) return; // Prevent search if auth not ready
            const clientsColRef = collection(db, `artifacts/${appId}/users/${userId}/clients`);
            const snapshot = await getDocs(clientsColRef);
            const clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderClients(clients); // Re-render with current search term and highlighting
        });
        deleteAllClientsBtn.addEventListener('click', deleteAllClients);

        addProductToOrderBtn.addEventListener('click', addProductToCurrentOrder);
        registerOrderBtn.addEventListener('click', registerOrder);

        // Placeholder for PDF export functionality (general PDF button in header)
        exportPdfBtn.addEventListener('click', async () => {
            console.log("Exportar PDF del pedido actual (funcionalidad en desarrollo).");
        });

        // Placeholder for PDF export functionality (summary PDF button)
        exportSummaryPdfBtn.addEventListener('click', () => {
            console.log("Exportar resumen de pedidos a PDF (funcionalidad en desarrollo).");
        });

    </script>
</body>
</html>
